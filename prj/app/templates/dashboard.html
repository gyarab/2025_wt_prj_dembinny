{% extends 'base.html' %}
{% block title %}Dashboard ‚Äî Class Fund Manager{% endblock %}

{% block content %}

<!-- Greeting -->
<div class="greeting">
    <h1>Hello, {{ user.get_full_name|default:user.username }}! üëã</h1>
    <p>Here's your Class Fund overview for today, {{ today|date:"F j, Y" }}.</p>
</div>

<!-- Summary cards -->
<div class="stats">
    <div class="stat-card danger">
        <div class="label">Still Owed</div>
        <div class="value">{{ total_owed }} CZK</div>
    </div>
    <div class="stat-card success">
        <div class="label">Total Paid</div>
        <div class="value">{{ total_paid }} CZK</div>
    </div>
    <div class="stat-card warning">
        <div class="label">Pending Requests</div>
        <div class="value">{{ unpaid_requests.count }}</div>
    </div>
    <div class="stat-card">
        <div class="label">Awaiting Confirmation</div>
        <div class="value">{{ awaiting_requests.count }}</div>
    </div>
    {% if show_fund_balance %}
    <div class="stat-card {% if fund_balance >= 0 %}fund-positive{% else %}fund-negative{% endif %}">
        <div class="label">üè¶ Class Fund Balance</div>
        <div class="value fund-balance-value">{{ fund_balance }} CZK</div>
        <div class="fund-breakdown">
            <span>‚Üë {{ fund_collected }} collected</span>
            <span>‚Üì {{ fund_spent }} spent</span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Unpaid payment requests -->
<div class="section">
    <h2>üìã Payments Due
        <a href="{% url 'pending_payments' %}"
            style="font-size:.8rem;font-weight:400;margin-left:.75rem;color:#1a1a2e;">View all ‚Üí</a>
    </h2>
    {% if unpaid_requests %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for req in unpaid_requests %}
            <tr class="clickable-row" onclick="window.location='{% url 'pending_payments' %}'"
                title="View all pending payments">
                <td><strong>{{ req.title }}</strong></td>
                <td style="color:#666;font-size:.85rem;">{{ req.description|truncatechars:60|default:"‚Äî" }}</td>
                <td><strong>{{ req.amount }} CZK</strong></td>
                <td>
                    {% if req.due_date %}
                    {% if req.is_overdue %}
                    <span class="overdue">{{ req.due_date|date:"d.m.Y" }} ‚ö† Overdue</span>
                    {% else %}
                    {{ req.due_date|date:"d.m.Y" }}
                    {% endif %}
                    {% else %}
                    <span style="color:#aaa;">‚Äî</span>
                    {% endif %}
                </td>
                <td><span class="badge badge-danger">Unpaid</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty">‚úÖ You have no outstanding payments. Great job!</p>
    {% endif %}
</div>

<!-- Awaiting treasurer confirmation -->
{% if awaiting_requests %}
<div class="section">
    <h2>‚è≥ Awaiting Confirmation</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for req in awaiting_requests %}
            <tr class="clickable-row" onclick="window.location='{% url 'pending_payments' %}'"
                title="View all pending payments">
                <td>{{ req.title }}</td>
                <td>{{ req.amount }} CZK</td>
                <td>{{ req.due_date|date:"d.m.Y"|default:"‚Äî" }}</td>
                <td><span class="badge badge-warning">Pending</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Payment history -->
<div class="section">
    <h2>üßæ My Payment History</h2>
    {% if my_transactions %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Request</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
                <th>Note</th>
            </tr>
        </thead>
        <tbody>
            {% for tx in my_transactions %}
            <tr>
                <td>{{ tx.payment_request.title }}</td>
                <td>{{ tx.amount }} CZK</td>
                <td>
                    {% if tx.status == 'confirmed' %}
                    <span class="badge badge-success">Confirmed</span>
                    {% elif tx.status == 'pending' %}
                    <span class="badge badge-warning">Pending</span>
                    {% else %}
                    <span class="badge badge-secondary">Rejected</span>
                    {% endif %}
                </td>
                <td>{{ tx.created_at|date:"d.m.Y" }}</td>
                <td>{{ tx.note|default:"‚Äî" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty">No payment history yet.</p>
    {% endif %}
</div>

<!-- Recent expenses from the fund -->
<div class="section">
    <h2>üí∏ Recent Fund Expenses</h2>
    {% if recent_expenses %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Amount</th>
                <th>Category</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in recent_expenses %}
            <tr>
                <td>{{ exp.title }}</td>
                <td>{{ exp.amount }} CZK</td>
                <td><span class="badge badge-secondary">{{ exp.get_category_display }}</span></td>
                <td>{{ exp.spent_at|date:"d.m.Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
    <!-- How to Pay teaser -->
    <div class="section">
        <h2>üè¶ How to Pay</h2>
        <div
            style="background:#fff;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,.07);padding:1.25rem 1.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
            <div>
                <strong style="font-size:1rem;">Bank transfer details &amp; QR code</strong>
                <p style="color:#666;font-size:.88rem;margin-top:.3rem;">Scan the QR code or copy the account number to
                    pay directly from your banking app.</p>
            </div>
            <a href="{% url 'payment_info' %}"
                style="background:#1a1a2e;color:#e2b96f;padding:.6rem 1.4rem;border-radius:6px;text-decoration:none;font-weight:600;white-space:nowrap;">View
                Details ‚Üí</a>
        </div>
    </div>
    {% endblock %}