{% extends 'base.html' %}
{% block title %}Pending Payments ‚Äî Class Fund Manager{% endblock %}

{% block content %}
<style>
    .page-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }
    .page-header h1 { font-size: 1.6rem; font-weight: 700; }
    .page-header a   { font-size: .9rem; color: #555; text-decoration: none; }
    .page-header a:hover { color: #1a1a2e; }

    .summary-bar {
        background: #fff;
        border-left: 5px solid #dc3545;
        border-radius: 6px;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 6px rgba(0,0,0,.06);
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .summary-bar .amount {
        font-size: 1.8rem;
        font-weight: 800;
        color: #dc3545;
    }
    .summary-bar .label {
        font-size: .85rem;
        color: #666;
    }

    .section { margin-bottom: 2.5rem; }
    .section h2 {
        font-size: 1.05rem; font-weight: 700;
        border-bottom: 2px solid #e8e8e8;
        padding-bottom: .4rem; margin-bottom: 1rem;
        color: #1a1a2e;
    }

    /* Payment card list */
    .payment-list { display: flex; flex-direction: column; gap: .85rem; }
    .payment-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 6px rgba(0,0,0,.07);
        padding: 1rem 1.25rem;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: .25rem 1.5rem;
        align-items: start;
        border-left: 4px solid #dc3545;
        transition: box-shadow .15s;
    }
    .payment-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,.1); }
    .payment-card.overdue-card { border-color: #b02030; background: #fff8f8; }
    .payment-card.awaiting-card { border-color: #ffc107; }

    .payment-card .card-title {
        font-weight: 700; font-size: 1rem; grid-column: 1;
    }
    .payment-card .card-desc {
        font-size: .85rem; color: #666; grid-column: 1; margin-top: .15rem;
    }
    .payment-card .card-meta {
        font-size: .8rem; color: #888; grid-column: 1; margin-top: .4rem;
        display: flex; gap: 1.25rem; flex-wrap: wrap;
    }
    .payment-card .card-amount {
        font-size: 1.35rem; font-weight: 800; color: #1a1a2e;
        grid-row: 1 / 3; grid-column: 2; text-align: right;
        white-space: nowrap;
    }
    .payment-card .card-amount small { font-size: .6em; font-weight: 400; color: #888; }

    .badge {
        display: inline-block; padding: .18rem .5rem;
        border-radius: 12px; font-size: .72rem; font-weight: 600;
    }
    .badge-danger    { background: #f8d7da; color: #721c24; }
    .badge-warning   { background: #fff3cd; color: #856404; }
    .badge-overdue   { background: #b02030; color: #fff; }

    .overdue-text { color: #b02030; font-weight: 600; }
    .empty { color: #888; font-style: italic; padding: .75rem 0; font-size: .9rem; }
</style>

<div class="page-header">
    <h1>üìã My Pending Payments</h1>
    <a href="{% url 'dashboard' %}">‚Üê Back to Dashboard</a>
</div>

<!-- Total owed banner -->
<div class="summary-bar">
    <div>
        <div class="amount">{{ total_owed }} CZK</div>
        <div class="label">total currently owed</div>
    </div>
    {% if unpaid_requests %}
    <div style="color:#666;font-size:.9rem;">
        {{ unpaid_requests.count }} unpaid request{{ unpaid_requests.count|pluralize }}{% if awaiting_requests %} +
        {{ awaiting_requests.count }} awaiting confirmation{% endif %}
    </div>
    {% endif %}
</div>

<!-- Overdue section ‚Äî shown only when there are overdue items -->
{% with overdue_list=unpaid_requests|dictsort:"due_date" %}
{% if unpaid_requests %}
{% for req in unpaid_requests %}{% if req.is_overdue %}{% if forloop.first %}
<div class="section">
    <h2>‚ö† Overdue</h2>
    <div class="payment-list">
{% endif %}
        <div class="payment-card overdue-card">
            <div class="card-title">{{ req.title }}</div>
            {% if req.description %}<div class="card-desc">{{ req.description }}</div>{% endif %}
            <div class="card-meta">
                <span><strong>Due:</strong> <span class="overdue-text">{{ req.due_date|date:"d.m.Y" }}</span></span>
                <span><span class="badge badge-overdue">Overdue</span></span>
            </div>
            <div class="card-amount">{{ req.amount }}<br><small>CZK</small></div>
        </div>
{% if forloop.last or not forloop.revcounter %}</div></div>{% endif %}
{% endif %}{% endfor %}
{% endif %}
{% endwith %}

<!-- Upcoming / no due date -->
<div class="section">
    <h2>üí≥ Unpaid</h2>
    {% with non_overdue=unpaid_requests %}
    {% if non_overdue %}
    <div class="payment-list">
        {% for req in non_overdue %}
        {% if not req.is_overdue %}
        <div class="payment-card">
            <div class="card-title">{{ req.title }}</div>
            {% if req.description %}<div class="card-desc">{{ req.description }}</div>{% endif %}
            <div class="card-meta">
                {% if req.due_date %}
                    <span><strong>Due:</strong> {{ req.due_date|date:"d.m.Y" }}</span>
                {% else %}
                    <span style="color:#aaa;">No due date</span>
                {% endif %}
                <span><span class="badge badge-danger">Unpaid</span></span>
            </div>
            <div class="card-amount">{{ req.amount }}<br><small>CZK</small></div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <p class="empty">‚úÖ No unpaid requests. You're all caught up!</p>
    {% endif %}
    {% endwith %}
</div>

<!-- Awaiting confirmation -->
{% if awaiting_requests %}
<div class="section">
    <h2>‚è≥ Awaiting Treasurer Confirmation</h2>
    <div class="payment-list">
        {% for req in awaiting_requests %}
        <div class="payment-card awaiting-card">
            <div class="card-title">{{ req.title }}</div>
            {% if req.description %}<div class="card-desc">{{ req.description }}</div>{% endif %}
            <div class="card-meta">
                {% if req.due_date %}
                    <span><strong>Due:</strong> {{ req.due_date|date:"d.m.Y" }}</span>
                {% endif %}
                <span><span class="badge badge-warning">Pending confirmation</span></span>
            </div>
            <div class="card-amount">{{ req.amount }}<br><small>CZK</small></div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if not unpaid_requests and not awaiting_requests %}
<div style="text-align:center;padding:3rem 1rem;color:#888;">
    <div style="font-size:3rem;margin-bottom:1rem;">üéâ</div>
    <h2 style="color:#1a1a2e;">You're all paid up!</h2>
    <p style="margin-top:.5rem;">There are no pending payment requests for your account.</p>
</div>
{% endif %}
{% endblock %}
