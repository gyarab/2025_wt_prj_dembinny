{% extends 'base.html' %}
{% block title %}Pending Payments ‚Äî Class Fund Manager{% endblock %}

{% block content %}

<div class="page-header">
    <h1>üìã My Pending Payments</h1>
    <a href="{% url 'dashboard' %}">‚Üê Back to Dashboard</a>
</div>

<!-- Total owed banner -->
<div class="summary-bar">
    <div>
        <div class="amount">{{ total_owed }} CZK</div>
        <div class="label">total currently owed</div>
    </div>
    {% if unpaid_requests %}
    <div style="color:#666;font-size:.9rem;">
        {{ unpaid_requests.count }} unpaid request{{ unpaid_requests.count|pluralize }}{% if awaiting_requests %} +
        {{ awaiting_requests.count }} awaiting confirmation{% endif %}
    </div>
    {% endif %}
</div>

<!-- Overdue section ‚Äî shown only when there are overdue items -->
{% with overdue_list=unpaid_requests|dictsort:"due_date" %}
{% if unpaid_requests %}
{% for req in unpaid_requests %}{% if req.is_overdue %}{% if forloop.first %}
<div class="section">
    <h2>‚ö† Overdue</h2>
    <div class="payment-list">
        {% endif %}
        <div class="payment-card overdue-card">
            <div class="card-title">{{ req.title }}</div>
            {% if req.description %}<div class="card-desc">{{ req.description }}</div>{% endif %}
            <div class="card-meta">
                <span><strong>Due:</strong> <span class="overdue-text">{{ req.due_date|date:"d.m.Y" }}</span></span>
                <span><span class="badge badge-overdue">Overdue</span></span>
            </div>
            <div class="card-amount">{{ req.amount }}<br><small>CZK</small></div>
            {% if req.qr_base64 %}
            <details class="qr-toggle">
                <summary>üì± Show QR &amp; payment symbols</summary>
                <div class="qr-panel">
                    <img src="data:image/png;base64,{{ req.qr_base64 }}" alt="QR code for {{ req.title }}">
                    <div class="qr-details">
                        <div class="qr-row">
                            <label>Amount</label>
                            <span class="qr-value">{{ req.amount }} CZK</span>
                        </div>
                        {% if req.variable_symbol %}
                        <div class="qr-row">
                            <label>Variable Symbol (VS)</label>
                            <span class="qr-value" id="vs-ov-{{ req.pk }}">{{ req.variable_symbol }}</span>
                            <button class="copy-btn" onclick="copyEl('vs-ov-{{ req.pk }}',this)">Copy</button>
                        </div>
                        {% endif %}
                        {% if req.specific_symbol %}
                        <div class="qr-row">
                            <label>Specific Symbol (SS)</label>
                            <span class="qr-value" id="ss-ov-{{ req.pk }}">{{ req.specific_symbol }}</span>
                            <button class="copy-btn" onclick="copyEl('ss-ov-{{ req.pk }}',this)">Copy</button>
                        </div>
                        {% endif %}
                        {% if account %}
                        <div class="qr-row">
                            <label>Account</label>
                            <span class="qr-value">{{ account.account_number }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </details>
            {% endif %}
        </div>
        {% if forloop.last or not forloop.revcounter %}
    </div>
</div>{% endif %}
{% endif %}{% endfor %}
{% endif %}
{% endwith %}

<!-- Upcoming / no due date -->
<div class="section">
    <h2>üí≥ Unpaid</h2>
    {% with non_overdue=unpaid_requests %}
    {% if non_overdue %}
    <div class="payment-list">
        {% for req in non_overdue %}
        {% if not req.is_overdue %}
        <div class="payment-card">
            <div class="card-title">{{ req.title }}</div>
            {% if req.description %}<div class="card-desc">{{ req.description }}</div>{% endif %}
            <div class="card-meta">
                {% if req.due_date %}
                <span><strong>Due:</strong> {{ req.due_date|date:"d.m.Y" }}</span>
                {% else %}
                <span style="color:#aaa;">No due date</span>
                {% endif %}
                <span><span class="badge badge-danger">Unpaid</span></span>
            </div>
            <div class="card-amount">{{ req.amount }}<br><small>CZK</small></div>
            {% if req.qr_base64 %}
            <details class="qr-toggle">
                <summary>üì± Show QR &amp; payment symbols</summary>
                <div class="qr-panel">
                    <img src="data:image/png;base64,{{ req.qr_base64 }}" alt="QR code for {{ req.title }}">
                    <div class="qr-details">
                        <div class="qr-row">
                            <label>Amount</label>
                            <span class="qr-value">{{ req.amount }} CZK</span>
                        </div>
                        {% if req.variable_symbol %}
                        <div class="qr-row">
                            <label>Variable Symbol (VS)</label>
                            <span class="qr-value" id="vs-up-{{ req.pk }}">{{ req.variable_symbol }}</span>
                            <button class="copy-btn" onclick="copyEl('vs-up-{{ req.pk }}',this)">Copy</button>
                        </div>
                        {% endif %}
                        {% if req.specific_symbol %}
                        <div class="qr-row">
                            <label>Specific Symbol (SS)</label>
                            <span class="qr-value" id="ss-up-{{ req.pk }}">{{ req.specific_symbol }}</span>
                            <button class="copy-btn" onclick="copyEl('ss-up-{{ req.pk }}',this)">Copy</button>
                        </div>
                        {% endif %}
                        {% if account %}
                        <div class="qr-row">
                            <label>Account</label>
                            <span class="qr-value">{{ account.account_number }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </details>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <p class="empty">‚úÖ No unpaid requests. You're all caught up!</p>
    {% endif %}
    {% endwith %}
</div>

<!-- Awaiting confirmation -->
{% if awaiting_requests %}
<div class="section">
    <h2>‚è≥ Awaiting Treasurer Confirmation</h2>
    <div class="payment-list">
        {% for req in awaiting_requests %}
        <div class="payment-card awaiting-card">
            <div class="card-title">{{ req.title }}</div>
            {% if req.description %}<div class="card-desc">{{ req.description }}</div>{% endif %}
            <div class="card-meta">
                {% if req.due_date %}
                <span><strong>Due:</strong> {{ req.due_date|date:"d.m.Y" }}</span>
                {% endif %}
                <span><span class="badge badge-warning">Pending confirmation</span></span>
            </div>
            <div class="card-amount">{{ req.amount }}<br><small>CZK</small></div>
            {% if req.qr_base64 %}
            <details class="qr-toggle">
                <summary>üì± Show QR &amp; payment symbols</summary>
                <div class="qr-panel">
                    <img src="data:image/png;base64,{{ req.qr_base64 }}" alt="QR code for {{ req.title }}">
                    <div class="qr-details">
                        <div class="qr-row">
                            <label>Amount</label>
                            <span class="qr-value">{{ req.amount }} CZK</span>
                        </div>
                        {% if req.variable_symbol %}
                        <div class="qr-row">
                            <label>Variable Symbol (VS)</label>
                            <span class="qr-value" id="vs-aw-{{ req.pk }}">{{ req.variable_symbol }}</span>
                            <button class="copy-btn" onclick="copyEl('vs-aw-{{ req.pk }}',this)">Copy</button>
                        </div>
                        {% endif %}
                        {% if req.specific_symbol %}
                        <div class="qr-row">
                            <label>Specific Symbol (SS)</label>
                            <span class="qr-value" id="ss-aw-{{ req.pk }}">{{ req.specific_symbol }}</span>
                            <button class="copy-btn" onclick="copyEl('ss-aw-{{ req.pk }}',this)">Copy</button>
                        </div>
                        {% endif %}
                        {% if account %}
                        <div class="qr-row">
                            <label>Account</label>
                            <span class="qr-value">{{ account.account_number }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </details>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if not unpaid_requests and not awaiting_requests %}
<div style="text-align:center;padding:3rem 1rem;color:#888;">
    <div style="font-size:3rem;margin-bottom:1rem;">üéâ</div>
    <h2 style="color:#1a1a2e;">You're all paid up!</h2>
    <p style="margin-top:.5rem;">There are no pending payment requests for your account.</p>
</div>
{% endif %}

<script>
    function copyEl(id, btn) {
        const text = document.getElementById(id).textContent.trim();
        navigator.clipboard.writeText(text).then(() => {
            btn.textContent = '‚úì Copied';
            btn.classList.add('copied');
            setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
        });
    }
</script>
{% endblock %}