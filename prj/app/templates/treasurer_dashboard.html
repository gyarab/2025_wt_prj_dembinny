{% extends 'base.html' %}
{% block title %}Treasurer Dashboard â€” Class Fund Manager{% endblock %}

{% block content %}

<!-- Page header -->
<div class="page-header">
    <h1>âš™ Treasurer Dashboard</h1>
    <span style="font-size:.9rem;color:#888;">{{ today|date:"F j, Y" }}</span>
</div>

<!-- â”€â”€ Fund summary cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="fund-summary">
    <div class="fund-card income">
        <div class="fc-label">ğŸ’° Total Collected</div>
        <div class="fc-value">{{ fund_collected }} CZK</div>
    </div>
    <div class="fund-card expense">
        <div class="fc-label">ğŸ’¸ Total Spent</div>
        <div class="fc-value">{{ fund_spent }} CZK</div>
    </div>
    <div class="fund-card balance">
        <div class="fc-label">ğŸ¦ Fund Balance</div>
        <div class="fc-value {% if fund_balance < 0 %}negative{% endif %}">{{ fund_balance }} CZK</div>
    </div>
    <div class="fund-card">
        <div class="fc-label">â³ Awaiting Payment</div>
        <div class="fc-value">{{ submitted_items|length|add:missing_items|length }}</div>
    </div>
</div>

<!-- â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab(event,'tab-students')">ğŸ‘¥ Students</button>
    <button class="tab-btn" onclick="switchTab(event,'tab-requests')">ğŸ“‹ Payment Requests</button>
    <button class="tab-btn" onclick="switchTab(event,'tab-pending')">
        â³ Pending
        {% with total=submitted_items|length|add:missing_items|length %}
        {% if total %}<span class="badge badge-warning">{{ total }}</span>{% endif %}
        {% endwith %}
    </button>
    <button class="tab-btn" onclick="switchTab(event,'tab-expenses')">ğŸ’¸ Expenses</button>
</div>

<!-- â”€â”€ TAB: Students â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="tab-students" class="tab-panel active">
    <div class="section">
        <h2>ğŸ‘¥ All Students</h2>
        {% if student_rows %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>âœ… Paid</th>
                    <th>â³ Pending</th>
                    <th>âŒ Missing</th>
                    <th>Amount Paid</th>
                    <th>Still Owes</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for row in student_rows %}
                <tr>
                    <td>
                        <strong>{{ row.student.get_full_name|default:row.student.username }}</strong>
                        {% if row.student.email %}
                        <br><span style="font-size:.78rem;color:#888;">{{ row.student.email }}</span>
                        {% endif %}
                    </td>
                    <td class="student-status-ok">{{ row.paid_count }}</td>
                    <td>
                        {% if row.pending_count %}
                        <span class="student-status-partial">{{ row.pending_count }}</span>
                        {% else %}â€”{% endif %}
                    </td>
                    <td>
                        {% if row.missing_count %}
                        <span class="student-status-bad">{{ row.missing_count }}</span>
                        {% else %}<span class="student-status-ok">0</span>{% endif %}
                    </td>
                    <td><strong>{{ row.paid_total }} CZK</strong></td>
                    <td>
                        {% if row.owed_total %}
                        <span class="student-status-bad">{{ row.owed_total }} CZK</span>
                        {% else %}<span class="student-status-ok">0 CZK</span>{% endif %}
                    </td>
                    <td>
                        {% if row.missing_count == 0 and row.pending_count == 0 %}
                        <span class="badge badge-success">All paid âœ“</span>
                        {% elif row.missing_count == 0 %}
                        <span class="badge badge-warning">Confirming</span>
                        {% else %}
                        <span class="badge badge-danger">Owes money</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.missing_count > 0 or row.pending_count > 0 %}
                        <a href="{% url 'log_transaction' %}?student={{ row.student.pk }}" class="btn-log-tx" title="Log a transfer for this student">ğŸ’³</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No student accounts found.</p>
        {% endif %}
    </div>
</div>

<!-- â”€â”€ TAB: Payment Requests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="tab-requests" class="tab-panel">
    <div class="section">
        <div class="section-header-row">
            <h2>ğŸ“‹ Payment Requests</h2>
            <a href="{% url 'create_payment_request' %}" class="btn-new-request">+ New Request</a>
        </div>
        {% if all_requests %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Due Date</th>
                    <th>Progress</th>
                    <th>Collected</th>
                </tr>
            </thead>
            <tbody>
                {% for pr in all_requests %}
                <tr>
                    <td>
                        <strong>{{ pr.title }}</strong>
                        {% if pr.is_overdue %}<span class="badge badge-overdue" style="margin-left:.4rem;">Overdue</span>{% endif %}
                        {% if pr.description %}
                        <br><span style="font-size:.78rem;color:#888;">{{ pr.description|truncatechars:70
                            }}</span>
                        {% endif %}
                        {% if pr.variable_symbol or pr.specific_symbol %}
                        <br><span style="font-size:.72rem;color:#aaa;">
                            {% if pr.variable_symbol %}VS: {{ pr.variable_symbol }}{% endif %}
                            {% if pr.specific_symbol %} Â· SS: {{ pr.specific_symbol }}{% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td><strong>{{ pr.amount }} CZK</strong></td>
                    <td>
                        {% if pr.due_date %}
                        {% if pr.is_overdue %}
                        <span class="overdue">{{ pr.due_date|date:"d.m.Y" }}</span>
                        {% else %}
                        {{ pr.due_date|date:"d.m.Y" }}
                        {% endif %}
                        {% else %}
                        <span style="color:#aaa;">â€”</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="req-progress">
                            <div class="counts">
                                <span class="cnt-ok">{{ pr.confirmed_count }} confirmed</span>
                                {% if pr.pending_count %}<span class="cnt-pending">{{ pr.pending_count }}
                                    pending</span>{% endif %}
                                {% if pr.missing_count %}<span class="cnt-missing">{{ pr.missing_count }}
                                    missing</span>{% endif %}
                                <span style="color:#aaa;">/ {{ pr.expected_count }}</span>
                            </div>
                            {% if pr.expected_count > 0 %}
                            {% widthratio pr.confirmed_count pr.expected_count 100 as pct %}
                            <div class="progress-wrap">
                                <div class="progress-bar {% if pct < 40 %}low{% elif pct < 80 %}partial{% endif %}" style="width:{{ pct }}%"></div>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <strong>{{ pr.collected }} CZK</strong><br>
                        <span style="font-size:.78rem;color:#aaa;">of {{ pr.expected_total }} CZK</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No payment requests yet. Add one via the <a href="/admin/app/paymentrequest/add/">admin
                panel</a>.</p>
        {% endif %}
    </div>
</div>

<!-- â”€â”€ TAB: Pending Transactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="tab-pending" class="tab-panel">
    <div class="section">
        <div class="section-header-row">
            <h2>â³ Payments to Process</h2>
            <a href="{% url 'log_transaction' %}" class="btn-new-request">ğŸ’³ Log Transfer</a>
        </div>

        <!-- â”€â”€ Sub-section: Student-submitted payments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <h3 class="subsection-heading">
            ğŸ“¥ Submitted by Students
            {% if submitted_items %}<span class="badge badge-warning">{{ submitted_items|length }}</span>{% endif %}
        </h3>
        {% if submitted_items %}
        <p class="section-hint">The student claims they paid â€” click <strong>âœ“ Confirm</strong> once you see the money in the bank.</p>
        <table class="data-table pending-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Payment Request</th>
                    <th>Amount</th>
                    <th>Submitted</th>
                    <th>Note</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for item in submitted_items %}
                <tr>
                    <td><strong>{{ item.student.get_full_name|default:item.student.username }}</strong></td>
                    <td>{{ item.payment_request.title }}</td>
                    <td><strong>{{ item.tx.amount }} CZK</strong></td>
                    <td style="font-size:.82rem;color:#888;">{{ item.tx.created_at|date:"d.m.Y" }}</td>
                    <td style="font-size:.82rem;color:#666;">{{ item.tx.note|truncatechars:40|default:"â€”" }}</td>
                    <td>
                            <form method="post" action="{% url 'confirm_pending' %}" style="display:inline">
                                {% csrf_token %}
                                <input type="hidden" name="tx_id" value="{{ item.tx.pk }}">
                                <button type="submit" class="btn-confirm-tx">âœ“ Confirm</button>
                            </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No student-submitted payments waiting.</p>
        {% endif %}

        <!-- â”€â”€ Sub-section: Not yet paid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <h3 class="subsection-heading" style="margin-top:2rem;">
            âŒ Not Yet Paid
            {% if missing_items %}<span class="badge badge-danger">{{ missing_items|length }}</span>{% endif %}
        </h3>
        {% if missing_items %}
        <p class="section-hint">These students haven't paid yet â€” click <strong>ğŸ’³ Log</strong> to record a transfer for them directly.</p>
        <table class="data-table pending-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Payment Request</th>
                    <th>Amount Due</th>
                    <th>Due Date</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for item in missing_items %}
                <tr {% if item.payment_request.is_overdue %}class="row-overdue" {% endif %}>
                    <td><strong>{{ item.student.get_full_name|default:item.student.username }}</strong></td>
                    <td>
                        {{ item.payment_request.title }}
                        {% if item.payment_request.is_overdue %}
                        <span class="badge badge-overdue" style="margin-left:.3rem;">Overdue</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ item.payment_request.amount }} CZK</strong></td>
                    <td style="font-size:.82rem;">
                        {% if item.payment_request.due_date %}
                        {% if item.payment_request.is_overdue %}
                        <span class="overdue">{{ item.payment_request.due_date|date:"d.m.Y" }}</span>
                        {% else %}
                        {{ item.payment_request.due_date|date:"d.m.Y" }}
                        {% endif %}
                        {% else %}<span style="color:#aaa;">â€”</span>{% endif %}
                    </td>
                    <td>
                        <a href="{% url 'log_transaction_prefill' pr_id=item.payment_request.pk student_id=item.student.pk %}" class="btn-log-direct">ğŸ’³ Log</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">âœ… All assigned students have paid or submitted payment.</p>
        {% endif %}
    </div>
</div>

<!-- â”€â”€ TAB: Expenses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="tab-expenses" class="tab-panel">
    <div class="section">
        <h2>ğŸ’¸ Recent Fund Expenses</h2>
        {% if recent_expenses %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Date</th>
                    <th>Recorded by</th>
                    <th>Published</th>
                </tr>
            </thead>
            <tbody>
                {% for exp in recent_expenses %}
                <tr>
                    <td>
                        <strong>{{ exp.title }}</strong>
                        {% if exp.description %}
                        <br><span style="font-size:.78rem;color:#888;">{{ exp.description|truncatechars:60
                            }}</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ exp.amount }} CZK</strong></td>
                    <td><span class="badge badge-secondary">{{ exp.get_category_display }}</span></td>
                    <td>{{ exp.spent_at|date:"d.m.Y" }}</td>
                    <td style="font-size:.85rem;">{{
                        exp.recorded_by.get_full_name|default:exp.recorded_by.username|default:"â€”" }}</td>
                    <td>
                        {% if exp.is_published %}
                        <span class="badge badge-success">Yes</span>
                        {% else %}
                        <span class="badge badge-secondary">No</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p style="margin-top:.75rem;font-size:.85rem;">
            <a href="/admin/app/expense/" style="color:#1a1a2e;font-weight:600;">Manage all expenses â†’</a>
        </p>
        {% else %}
        <p class="empty">No expenses recorded yet.</p>
        {% endif %}
    </div>
</div>

<script>
    function switchTab(e, id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        e.currentTarget.classList.add('active');
        document.getElementById(id).classList.add('active');
    }
</script>

{% endblock %}