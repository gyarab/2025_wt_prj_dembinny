{% extends 'base.html' %}
{% block title %}Treasurer Dashboard ‚Äî Class Fund Manager{% endblock %}

{% block content %}

<!-- Page header -->
<div class="page-header">
    <h1>‚öô Treasurer Dashboard</h1>
    <span style="font-size:.9rem;color:#888;">{{ today|date:"F j, Y" }}</span>
</div>

<!-- ‚îÄ‚îÄ Fund summary cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="fund-summary">
    <div class="fund-card income">
        <div class="fc-label">üí∞ Total Collected</div>
        <div class="fc-value">{{ total_collected }} CZK</div>
    </div>
    <div class="fund-card expense">
        <div class="fc-label">üí∏ Total Spent</div>
        <div class="fc-value">{{ total_spent }} CZK</div>
    </div>
    <div class="fund-card balance">
        <div class="fc-label">üè¶ Fund Balance</div>
        <div class="fc-value {% if balance < 0 %}negative{% endif %}">{{ balance }} CZK</div>
    </div>
    <div class="fund-card">
        <div class="fc-label">‚è≥ Awaiting Confirmation</div>
        <div class="fc-value">{{ pending_transactions.count }}</div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab(event,'tab-students')">üë• Students</button>
    <button class="tab-btn" onclick="switchTab(event,'tab-requests')">üìã Payment Requests</button>
    <button class="tab-btn" onclick="switchTab(event,'tab-pending')">
        ‚è≥ Pending Transactions{% if pending_transactions %} <span class="badge badge-warning">{{
            pending_transactions.count }}</span>{% endif %}
    </button>
    <button class="tab-btn" onclick="switchTab(event,'tab-expenses')">üí∏ Expenses</button>
</div>

<!-- ‚îÄ‚îÄ TAB: Students ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-students" class="tab-panel active">
    <div class="section">
        <h2>üë• All Students</h2>
        {% if student_rows %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>‚úÖ Paid</th>
                    <th>‚è≥ Pending</th>
                    <th>‚ùå Missing</th>
                    <th>Amount Paid</th>
                    <th>Still Owes</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in student_rows %}
                <tr>
                    <td>
                        <strong>{{ row.student.get_full_name|default:row.student.username }}</strong>
                        {% if row.student.email %}
                        <br><span style="font-size:.78rem;color:#888;">{{ row.student.email }}</span>
                        {% endif %}
                    </td>
                    <td class="student-status-ok">{{ row.paid_count }}</td>
                    <td>
                        {% if row.pending_count %}
                        <span class="student-status-partial">{{ row.pending_count }}</span>
                        {% else %}‚Äî{% endif %}
                    </td>
                    <td>
                        {% if row.missing_count %}
                        <span class="student-status-bad">{{ row.missing_count }}</span>
                        {% else %}<span class="student-status-ok">0</span>{% endif %}
                    </td>
                    <td><strong>{{ row.paid_total }} CZK</strong></td>
                    <td>
                        {% if row.owed_total %}
                        <span class="student-status-bad">{{ row.owed_total }} CZK</span>
                        {% else %}<span class="student-status-ok">0 CZK</span>{% endif %}
                    </td>
                    <td>
                        {% if row.missing_count == 0 and row.pending_count == 0 %}
                        <span class="badge badge-success">All paid ‚úì</span>
                        {% elif row.missing_count == 0 %}
                        <span class="badge badge-warning">Confirming</span>
                        {% else %}
                        <span class="badge badge-danger">Owes money</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No student accounts found.</p>
        {% endif %}
    </div>
</div>

<!-- ‚îÄ‚îÄ TAB: Payment Requests ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-requests" class="tab-panel">
    <div class="section">
        <h2>üìã Payment Requests</h2>
        {% if all_requests %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Due Date</th>
                    <th>Progress</th>
                    <th>Collected</th>
                </tr>
            </thead>
            <tbody>
                {% for pr in all_requests %}
                <tr>
                    <td>
                        <strong>{{ pr.title }}</strong>
                        {% if pr.is_overdue %}<span class="badge badge-overdue"
                            style="margin-left:.4rem;">Overdue</span>{% endif %}
                        {% if pr.description %}
                        <br><span style="font-size:.78rem;color:#888;">{{ pr.description|truncatechars:70 }}</span>
                        {% endif %}
                        {% if pr.variable_symbol or pr.specific_symbol %}
                        <br><span style="font-size:.72rem;color:#aaa;">
                            {% if pr.variable_symbol %}VS: {{ pr.variable_symbol }}{% endif %}
                            {% if pr.specific_symbol %} ¬∑ SS: {{ pr.specific_symbol }}{% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td><strong>{{ pr.amount }} CZK</strong></td>
                    <td>
                        {% if pr.due_date %}
                        {% if pr.is_overdue %}
                        <span class="overdue">{{ pr.due_date|date:"d.m.Y" }}</span>
                        {% else %}
                        {{ pr.due_date|date:"d.m.Y" }}
                        {% endif %}
                        {% else %}
                        <span style="color:#aaa;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="req-progress">
                            <div class="counts">
                                <span class="cnt-ok">{{ pr.confirmed_count }} confirmed</span>
                                {% if pr.pending_count %}<span class="cnt-pending">{{ pr.pending_count }}
                                    pending</span>{% endif %}
                                {% if pr.missing_count %}<span class="cnt-missing">{{ pr.missing_count }}
                                    missing</span>{% endif %}
                                <span style="color:#aaa;">/ {{ pr.expected_count }}</span>
                            </div>
                            {% if pr.expected_count > 0 %}
                            {% widthratio pr.confirmed_count pr.expected_count 100 as pct %}
                            <div class="progress-wrap">
                                <div class="progress-bar {% if pct < 40 %}low{% elif pct < 80 %}partial{% endif %}"
                                    style="width:{{ pct }}%"></div>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <strong>{{ pr.collected }} CZK</strong><br>
                        <span style="font-size:.78rem;color:#aaa;">of {{ pr.expected_total }} CZK</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No payment requests yet. Add one via the <a href="/admin/app/paymentrequest/add/">admin
                panel</a>.</p>
        {% endif %}
    </div>
</div>

<!-- ‚îÄ‚îÄ TAB: Pending Transactions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-pending" class="tab-panel">
    <div class="section">
        <h2>‚è≥ Transactions Awaiting Confirmation</h2>
        {% if pending_transactions %}
        <p style="font-size:.88rem;color:#666;margin-bottom:1rem;">
            These students have submitted payment ‚Äî confirm or reject them in the
            <a href="/admin/app/transaction/?status__exact=pending">admin panel</a>.
        </p>
        <div class="tx-queue">
            {% for tx in pending_transactions %}
            <div class="tx-card">
                <div class="tx-title">{{ tx.student.get_full_name|default:tx.student.username }}</div>
                <div class="tx-meta">
                    {{ tx.payment_request.title }}
                    ¬∑ submitted {{ tx.created_at|date:"d.m.Y" }}
                    {% if tx.note %} ¬∑ <em>{{ tx.note|truncatechars:60 }}</em>{% endif %}
                </div>
                <div class="tx-amount">{{ tx.amount }}<br><small
                        style="font-size:.6em;font-weight:400;color:#888;">CZK</small></div>
            </div>
            {% endfor %}
        </div>
        <p style="margin-top:1rem;font-size:.85rem;">
            <a href="/admin/app/transaction/?status__exact=pending" style="color:#1a1a2e;font-weight:600;">
                Open in admin panel ‚Üí
            </a>
        </p>
        {% else %}
        <p class="empty">‚úÖ No transactions waiting for review.</p>
        {% endif %}
    </div>
</div>

<!-- ‚îÄ‚îÄ TAB: Expenses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-expenses" class="tab-panel">
    <div class="section">
        <h2>üí∏ Recent Fund Expenses</h2>
        {% if recent_expenses %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Date</th>
                    <th>Recorded by</th>
                    <th>Published</th>
                </tr>
            </thead>
            <tbody>
                {% for exp in recent_expenses %}
                <tr>
                    <td>
                        <strong>{{ exp.title }}</strong>
                        {% if exp.description %}
                        <br><span style="font-size:.78rem;color:#888;">{{ exp.description|truncatechars:60 }}</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ exp.amount }} CZK</strong></td>
                    <td><span class="badge badge-secondary">{{ exp.get_category_display }}</span></td>
                    <td>{{ exp.spent_at|date:"d.m.Y" }}</td>
                    <td style="font-size:.85rem;">{{
                        exp.recorded_by.get_full_name|default:exp.recorded_by.username|default:"‚Äî" }}</td>
                    <td>
                        {% if exp.is_published %}
                        <span class="badge badge-success">Yes</span>
                        {% else %}
                        <span class="badge badge-secondary">No</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p style="margin-top:.75rem;font-size:.85rem;">
            <a href="/admin/app/expense/" style="color:#1a1a2e;font-weight:600;">Manage all expenses ‚Üí</a>
        </p>
        {% else %}
        <p class="empty">No expenses recorded yet.</p>
        {% endif %}
    </div>
</div>

<script>
    function switchTab(e, id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        e.currentTarget.classList.add('active');
        document.getElementById(id).classList.add('active');
    }
</script>

{% endblock %}