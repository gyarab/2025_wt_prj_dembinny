{% extends 'core/base.html' %}
{% block title %}Dashboard ‚Äî Class Fund Manager{% endblock %}

{% block content %}

<!-- Greeting -->
<div class="mb-4">
    <h1 class="h3 fw-bold mb-1">Hello, {{ user.get_full_name|default:user.username }}! üëã</h1>
    <p class="text-muted">Here's your Class Fund overview for today, {{ today|date:"F j, Y" }}.</p>
</div>

<!-- Summary cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm stat-card-danger h-100">
            <div class="card-body">
                <div class="small text-muted mb-1">Still Owed</div>
                <div class="fs-4 fw-bold text-danger">{{ total_owed }} CZK</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm stat-card-success h-100">
            <div class="card-body">
                <div class="small text-muted mb-1">Total Paid</div>
                <div class="fs-4 fw-bold text-success">{{ total_paid }} CZK</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="small text-muted mb-1">Pending Requests</div>
                <div class="fs-4 fw-bold">{{ unpaid_requests.count }}</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="small text-muted mb-1">Awaiting Confirmation</div>
                <div class="fs-4 fw-bold">{{ awaiting_requests.count }}</div>
            </div>
        </div>
    </div>
    {% if show_fund_balance %}
    <div class="col-12 col-md-6">
        <div class="card border-0 shadow-sm {% if fund_balance >= 0 %}stat-card-fund-pos{% else %}stat-card-fund-neg{% endif %} h-100">
            <div class="card-body">
                <div class="small text-muted mb-1">üè¶ Class Fund Balance</div>
                <div class="fs-3 fw-bold {% if fund_balance >= 0 %}text-success{% else %}text-danger{% endif %}">{{ fund_balance }} CZK</div>
                <div class="small mt-1 text-muted">‚Üë {{ fund_collected }} collected &nbsp;¬∑&nbsp; ‚Üì {{ fund_spent }} spent</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Unpaid payment requests -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header d-flex align-items-center justify-content-between bg-white border-bottom">
        <h5 class="mb-0 fw-bold">üìã Payments Due</h5>
        <a href="{% url 'pending_payments' %}" class="btn btn-sm btn-outline-secondary">View all ‚Üí</a>
    </div>
    <div class="card-body p-0">
        {% if unpaid_requests %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Due Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in unpaid_requests %}
                    <tr class="clickable-row" onclick="window.location='{% url 'pending_payments' %}'" style="cursor:pointer;">
                        <td><strong>{{ req.title }}</strong></td>
                        <td class="text-muted small">{{ req.description|truncatechars:60|default:"‚Äî" }}</td>
                        <td><strong>{{ req.amount }} CZK</strong></td>
                        <td>
                            {% if req.due_date %}
                                {% if req.is_overdue %}
                                <span class="text-danger fw-semibold">{{ req.due_date|date:"d.m.Y" }} ‚ö†</span>
                                {% else %}
                                {{ req.due_date|date:"d.m.Y" }}
                                {% endif %}
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-danger">Unpaid</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="p-3 mb-0 text-muted">‚úÖ You have no outstanding payments. Great job!</p>
        {% endif %}
    </div>
</div>

<!-- Awaiting treasurer confirmation -->
{% if awaiting_requests %}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom">
        <h5 class="mb-0 fw-bold">‚è≥ Awaiting Confirmation</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Amount</th>
                        <th>Due Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in awaiting_requests %}
                    <tr class="clickable-row" onclick="window.location='{% url 'pending_payments' %}'" style="cursor:pointer;">
                        <td>{{ req.title }}</td>
                        <td>{{ req.amount }} CZK</td>
                        <td>{{ req.due_date|date:"d.m.Y"|default:"‚Äî" }}</td>
                        <td><span class="badge bg-warning text-dark">Pending</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Payment history -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom">
        <h5 class="mb-0 fw-bold">üßæ My Payment History</h5>
    </div>
    <div class="card-body p-0">
        {% if my_transactions %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Request</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in my_transactions %}
                    <tr>
                        <td>{{ tx.payment_request.title }}</td>
                        <td>{{ tx.amount }} CZK</td>
                        <td>
                            {% if tx.status == 'confirmed' %}
                            <span class="badge bg-success">Confirmed</span>
                            {% elif tx.status == 'pending' %}
                            <span class="badge bg-warning text-dark">Pending</span>
                            {% else %}
                            <span class="badge bg-secondary">Rejected</span>
                            {% endif %}
                        </td>
                        <td>{{ tx.created_at|date:"d.m.Y" }}</td>
                        <td class="text-muted small">{{ tx.note|default:"‚Äî" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="p-3 mb-0 text-muted">No payment history yet.</p>
        {% endif %}
    </div>
</div>

<!-- Recent expenses from the fund -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom">
        <h5 class="mb-0 fw-bold">üí∏ Recent Fund Expenses</h5>
    </div>
    <div class="card-body p-0">
        {% if recent_expenses %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exp in recent_expenses %}
                    <tr>
                        <td>{{ exp.title }}</td>
                        <td>{{ exp.amount }} CZK</td>
                        <td><span class="badge bg-secondary">{{ exp.get_category_display }}</span></td>
                        <td>{{ exp.spent_at|date:"d.m.Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- How to Pay teaser -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
            <strong class="d-block">üè¶ How to Pay</strong>
            <span class="text-muted small">Scan the QR code or copy the account number to pay directly from your banking app.</span>
        </div>
        <a href="{% url 'payment_info' %}" class="btn btn-cfm">View Details ‚Üí</a>
    </div>
</div>

{% endblock %}